<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Only load manifest in production (not in GitHub Codespaces) -->
    <script>
        if (!window.location.hostname.includes('github.dev') && !window.location.hostname.includes('app.github.dev')) {
            const link = document.createElement('link');
            link.rel = 'manifest';
            link.href = 'manifest.json';
            document.head.appendChild(link);
        }
    </script>
    <link rel="stylesheet" href="src/styles.css">
    <!-- Leaflet CSS (local copy to avoid browser SRI/parse warnings in dev) -->
    <link rel="stylesheet" href="src/leaflet.css" />
    <!-- Load leaflet.draw stylesheet as a normal stylesheet so it's applied before render to avoid FOUC -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" referrerpolicy="no-referrer">
    <title>VetsHub - Updated Oct 31 15:45</title>
</head>
<body>

    <header class="app-header">
        <div class="brand">
            <div class="logo">VB</div>
            <div class="title">Vetshub</div>
        </div>
        <div class="header-actions">
            <button id="export-btn" class="btn secondary">Export data</button>
            <label for="import-file" class="btn secondary">Import</label>
            <input id="import-file" type="file" accept="application/json" style="display:none" />
        </div>
    </header>

    <div class="layout">
        <aside class="sidebar nav">
            <button data-section="dashboard" class="active">Dashboard</button>
            <button data-section="crop">Crops</button>
            <button data-section="livestock">Livestock</button>
            <button data-section="inventory">Inventory</button>
            <button data-section="tasks">Tasks</button>
            <button data-section="finance">Finance</button>
            <button data-section="fields">Fields</button>
            <button data-section="activities">Activities</button>
            <button data-section="equipment">Equipment</button>
            <button data-section="contacts">Contacts</button>
            <button data-section="orders">Orders</button>
            <button data-section="animals">Animals</button>
            <button data-section="attachments">Attachments</button>
            <button data-section="reports">Reports</button>
        </aside>

    <main>
        <section id="dashboard" class="section active">
            <h2>Overview</h2>
            <nav class="subnav">
                <button data-sub="overview" class="active">Overview</button>
                <button data-sub="quick">Quick Actions</button>
                <button data-sub="alerts">Alerts</button>
            </nav>

            <div class="sub-section" id="dashboard-overview">
                <div id="overview-area">Loading overview...</div>
            </div>

            <div class="sub-section" id="dashboard-quick" style="display:none">
                <p>Quick actions and shortcuts.</p>
            </div>

            <div class="sub-section" id="dashboard-alerts" style="display:none">
                <p>Critical alerts and notifications.</p>
            </div>
        </section>

        <section id="crop" class="section">
            <h2>Crop Management</h2>
            <nav class="subnav">
                <button data-sub="overview" class="active">Overview</button>
                <button data-sub="manage">Manage</button>
                <button data-sub="plans">Planting Plans</button>
                <button data-sub="reports">Reports</button>
            </nav>

            <div class="sub-section" id="crop-overview">
                <div id="crop-overview-stats" class="stats">Loading...</div>
                <div id="crop-upcoming" class="card">
                    <h4>Upcoming Plantings</h4>
                    <ul id="crop-upcoming-list"></ul>
                </div>
            </div>

            <div class="sub-section" id="crop-manage">
                <form id="crop-form" class="item-form">
                    <input type="text" id="crop-name" placeholder="Crop name (e.g., Corn)" required />
                    <input type="text" id="crop-field" placeholder="Field / Plot" />
                    <input type="date" id="crop-planting" placeholder="Planting date" />
                    <button type="submit">Add Crop</button>
                </form>
                <div id="crop-list" class="item-list">No crops yet.</div>
            </div>

            <div class="sub-section" id="crop-plans" style="display:none">
                <h4>Planting Plans</h4>
                <div id="crop-plans-list">No plans yet.</div>
            </div>

            <div class="sub-section" id="crop-reports" style="display:none">
                <p>Crop reports and export options.</p>
            </div>
        </section>

        <section id="livestock" class="section">
            <h2>Livestock</h2>
            <nav class="subnav">
                <button data-sub="overview" class="active">Overview</button>
                <button data-sub="herd">Herd</button>
                <button data-sub="health">Health</button>
                <button data-sub="breeding">Breeding</button>
            </nav>

            <div class="sub-section" id="livestock-overview">
                <div id="livestock-stats" class="stats">Loading...</div>
            </div>

            <div class="sub-section" id="livestock-herd">
                <form id="livestock-form" class="item-form">
                    <input type="text" id="animal-id" placeholder="Animal ID / Tag" required />
                    <input type="text" id="animal-type" placeholder="Type (e.g., Cow)" />
                    <input type="text" id="animal-breed" placeholder="Breed" />
                    <button type="submit">Add Animal</button>
                </form>
                <div id="livestock-list" class="item-list">No animals yet.</div>
            </div>

            <div class="sub-section" id="livestock-health" style="display:none">
                <h4>Health Records</h4>
                <div id="livestock-health-list">No records.</div>
            </div>

            <div class="sub-section" id="livestock-breeding" style="display:none">
                <h4>Breeding</h4>
                <div id="livestock-breeding-list">No breeding records.</div>
            </div>
        </section>

        <section id="inventory" class="section">
            <h2>Inventory</h2>
            <nav class="subnav">
                <button data-sub="overview" class="active">Overview</button>
                <button data-sub="stock">Stock</button>
                <button data-sub="suppliers">Suppliers</button>
                <button data-sub="movements">Movements</button>
            </nav>

            <div class="sub-section" id="inventory-overview">
                <div id="inventory-stats" class="stats">Loading...</div>
            </div>

            <div class="sub-section" id="inventory-stock">
                <form id="inventory-form" class="item-form">
                    <input type="text" id="inv-name" placeholder="Item name (Feed, Seed, Fuel)" required />
                    <input type="number" id="inv-qty" placeholder="Quantity" step="any" />
                    <input type="text" id="inv-unit" placeholder="Unit (kg, L, units)" />
                    <button type="submit">Add Inventory</button>
                </form>
                <div id="inventory-list" class="item-list">No inventory yet.</div>
            </div>

            <div class="sub-section" id="inventory-suppliers" style="display:none">
                <h4>Suppliers</h4>
                <div id="inventory-suppliers-list">No suppliers yet.</div>
            </div>

            <div class="sub-section" id="inventory-movements" style="display:none">
                <p>Stock in/out movements and audit trail.</p>
            </div>
        </section>

        <section id="fields" class="section">
            <h2>Fields & Boundaries</h2>
            <nav class="subnav">
                <button data-sub="map" class="active">Map</button>
                <button data-sub="manage">Manage</button>
                <button data-sub="soil">Soil Tests</button>
                <button data-sub="reports">Reports</button>
            </nav>

            <div class="sub-section" id="fields-mapview">
                    <div class="fields-grid">
                        <div id="fields-map" style="height:420px; border-radius:8px; overflow:hidden;"></div>
                        <aside class="fields-panel card">
                            <div class="fields-stats">
                                <h4>Fields summary</h4>
                                <div id="fields-summary">Loading...</div>
                            </div>
                            <div class="card">
                                <h4>Quick actions</h4>
                                <div style="display:flex;gap:8px;flex-wrap:wrap">
                                    <button id="btn-new-field" class="btn">New field (form)</button>
                                    <button id="btn-export-fields" class="btn secondary">Export Fields (GeoJSON)</button>
                                    <button id="btn-refresh-fields" class="btn">Refresh</button>
                                </div>
                            </div>
                            <div class="card" style="flex:1;overflow:auto">
                                <h4>Recent fields</h4>
                                <div id="fields-recent-list" style="display:flex;flex-direction:column;gap:8px"></div>
                            </div>
                        </aside>
                    </div>
            </div>

            <div class="sub-section" id="fields-manage" style="display:none">
                <form id="field-form" class="item-form card">
                    <div class="full"><label for="field-name">Field name</label><input type="text" id="field-name" placeholder="Field name" required /></div>
                    <div class="field-row">
                        <div><label for="field-area">Area (ha)</label><input type="number" id="field-area" placeholder="Area in hectares" step="0.01" /></div>
                        <div><label for="field-soil">Soil type</label>
                            <select id="field-soil">
                                <option value="">-- select --</option>
                                <option>Loam</option>
                                <option>Clay</option>
                                <option>Sandy</option>
                                <option>Peat</option>
                                <option>Silt</option>
                            </select>
                        </div>
                    </div>
                    <div class="full"><label for="field-lastcrop">Last crop</label><input type="text" id="field-lastcrop" placeholder="e.g., Winter Wheat" /></div>
                    <div class="full"><label for="field-notes">Notes</label><textarea id="field-notes" rows="3" placeholder="Soil tests, drainage notes..."></textarea></div>
                    <div class="full"><label for="field-geojson">Geometry (GeoJSON)</label><textarea id="field-geojson" placeholder='Paste GeoJSON Polygon here (or leave blank)'></textarea></div>
                    <div class="full"><label for="field-photo">Photo (optional)</label><input type="file" id="field-photo" accept="image/*" capture="environment" /></div>
                    <div><button type="submit">Add Field</button></div>
                </form>

                <div class="card" style="margin-top:12px">
                    <h4>Saved fields</h4>
                    <div style="overflow:auto">
                        <table id="fields-table" class="simple" style="width:100%;min-width:920px;border-collapse:collapse">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Area (ha)</th>
                                    <th>Soil</th>
                                    <th>Last crop</th>
                                    <th>Notes</th>
                                    <th>Geometry</th>
                                    <th>Created</th>
                                    <th>Photos</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="9" class="muted">No fields yet.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="sub-section" id="fields-soil" style="display:none">
                <h4>Soil Tests</h4>
                <div id="fields-soil-list">No soil tests.</div>
            </div>

            <div class="sub-section" id="fields-reports" style="display:none">
                <h4>Field Reports</h4>
                <div id="fields-reports-list">No reports.</div>
            </div>
        </section>

        <section id="activities" class="section">
            <h2>Field Activities</h2>
            <nav class="subnav">
                <button data-sub="log" class="active">Log</button>
                <button data-sub="calendar">Calendar</button>
                <button data-sub="analytics">Analytics</button>
            </nav>

            <div class="sub-section" id="activities-log">
                <form id="activity-form" class="item-form">
                    <input type="text" id="act-type" placeholder="Activity type (weeding, harvest)" required />
                    <input type="date" id="act-date" />
                    <input type="text" id="act-field" placeholder="Field ID" />
                    <input type="text" id="act-crop" placeholder="Crop ID" />
                    <input type="text" id="act-worker" placeholder="Worker" />
                    <input type="number" id="act-cost" placeholder="Cost" step="0.01" />
                    <button type="button" id="geo-capture">Capture Location</button>
                    <input type="file" id="act-photo" accept="image/*" capture="environment" />
                    <input type="hidden" id="act-lat" />
                    <input type="hidden" id="act-lng" />
                    <button type="submit">Add Activity</button>
                </form>
                <div id="activities-list" class="item-list">No activities yet.</div>
            </div>

            <div class="sub-section" id="activities-calendar" style="display:none">
                <h4>Calendar</h4>
                <div id="activities-calendar-list">No scheduled activities.</div>
            </div>

            <div class="sub-section" id="activities-analytics" style="display:none">
                <h4>Analytics</h4>
                <div id="activities-analytics-area">Charts and summaries will appear here.</div>
            </div>
        </section>

        <section id="equipment" class="section">
            <h2>Equipment & Maintenance</h2>
            <nav class="subnav">
                <button data-sub="fleet" class="active">Fleet</button>
                <button data-sub="maintenance">Maintenance</button>
                <button data-sub="schedules">Schedules</button>
            </nav>

            <div class="sub-section" id="equipment-fleet">
                <form id="equipment-form" class="item-form">
                    <input type="text" id="equip-name" placeholder="Equipment name" required />
                    <input type="text" id="equip-type" placeholder="Type (tractor, harvester)" />
                    <input type="date" id="equip-purchase" />
                    <button type="submit">Add Equipment</button>
                </form>
                <div id="equipment-list" class="item-list">No equipment yet.</div>
            </div>

            <div class="sub-section" id="equipment-maintenance" style="display:none">
                <h4>Maintenance Logs</h4>
                <div id="equipment-maintenance-list">No maintenance logs.</div>
            </div>

            <div class="sub-section" id="equipment-schedules" style="display:none">
                <h4>Schedules</h4>
                <div id="equipment-schedules-list">No schedules.</div>
            </div>
        </section>

        <section id="contacts" class="section">
            <h2>Contacts & Vendors</h2>
            <nav class="subnav">
                <button data-sub="all" class="active">All</button>
                <button data-sub="vendors">Vendors</button>
                <button data-sub="buyers">Buyers</button>
            </nav>

            <div class="sub-section" id="contacts-all">
                <form id="contact-form" class="item-form">
                    <input type="text" id="contact-name" placeholder="Name / Vendor" required />
                    <input type="text" id="contact-type" placeholder="Type (vendor, buyer)" />
                    <input type="text" id="contact-phone" placeholder="Phone" />
                    <button type="submit">Add Contact</button>
                </form>
                <div id="contacts-list" class="item-list">No contacts yet.</div>
            </div>

            <div class="sub-section" id="contacts-vendors" style="display:none">
                <h4>Vendors</h4>
                <div id="contacts-vendors-list">No vendors.</div>
            </div>

            <div class="sub-section" id="contacts-buyers" style="display:none">
                <h4>Buyers</h4>
                <div id="contacts-buyers-list">No buyers.</div>
            </div>
        </section>

        <section id="orders" class="section">
            <h2>Orders & Sales</h2>
            <nav class="subnav">
                <button data-sub="sales" class="active">Sales</button>
                <button data-sub="purchases">Purchases</button>
                <button data-sub="invoices">Invoices</button>
            </nav>

            <div class="sub-section" id="orders-sales">
                <form id="order-form" class="item-form">
                    <input type="text" id="order-desc" placeholder="Order description" required />
                    <input type="number" id="order-amount" placeholder="Amount" step="0.01" />
                    <input type="date" id="order-date" />
                    <button type="submit">Add Order</button>
                </form>
                <div id="orders-list" class="item-list">No orders yet.</div>
            </div>

            <div class="sub-section" id="orders-purchases" style="display:none">
                <h4>Purchases</h4>
                <div id="orders-purchases-list">No purchase orders.</div>
            </div>

            <div class="sub-section" id="orders-invoices" style="display:none">
                <h4>Invoices</h4>
                <div id="orders-invoices-list">No invoices.</div>
            </div>
        </section>

        <section id="animals" class="section">
            <h2>Animals & Breeding Management</h2>
            <nav class="subnav">
                <button data-sub="list" class="active">Animals</button>
                <button data-sub="breeding">Breeding</button>
                <button data-sub="health">Health</button>
                <button data-sub="genealogy">Genealogy</button>
                <button data-sub="performance">Performance</button>
            </nav>

            <!-- Animals List Tab -->
            <div class="sub-section" id="animals-list">
                <div class="card">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                        <h4>Farm Animals Registry</h4>
                        <div style="display:flex;gap:8px">
                            <button id="btn-new-animal" class="btn">➕ Add Animal</button>
                            <button id="btn-bulk-import" class="btn secondary">📁 Import</button>
                            <button id="btn-export-animals" class="btn secondary">📊 Export</button>
                        </div>
                    </div>
                    
                    <!-- Filter and Search Controls -->
                    <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap">
                        <input type="text" id="animal-search" placeholder="🔍 Search by tag, name, or breed..." style="flex:1;min-width:250px" />
                        <select id="animal-filter-species" style="width:120px">
                            <option value="">All Species</option>
                            <option value="cattle">Cattle</option>
                            <option value="sheep">Sheep</option>
                            <option value="goat">Goat</option>
                            <option value="pig">Pig</option>
                            <option value="chicken">Chicken</option>
                            <option value="horse">Horse</option>
                            <option value="other">Other</option>
                        </select>
                        <select id="animal-filter-status" style="width:120px">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="pregnant">Pregnant</option>
                            <option value="lactating">Lactating</option>
                            <option value="breeding">Breeding</option>
                            <option value="sick">Sick</option>
                            <option value="sold">Sold</option>
                            <option value="deceased">Deceased</option>
                        </select>
                        <button id="btn-clear-filters" class="btn secondary" style="white-space:nowrap">Clear Filters</button>
                    </div>

                    <!-- Animals Data Table -->
                    <div id="animals-table-container" style="overflow-x:auto;max-height:600px;border:1px solid #ddd;border-radius:8px">
                        <table id="animals-table" class="data-table" style="width:100%;min-width:1200px">
                            <thead>
                                <tr>
                                    <th style="width:80px">Tag/ID</th>
                                    <th style="width:120px">Name</th>
                                    <th style="width:100px">Species</th>
                                    <th style="width:120px">Breed</th>
                                    <th style="width:60px">Sex</th>
                                    <th style="width:80px">Age</th>
                                    <th style="width:80px">Weight (kg)</th>
                                    <th style="width:100px">Status</th>
                                    <th style="width:120px">Location</th>
                                    <th style="width:100px">Sire</th>
                                    <th style="width:100px">Dam</th>
                                    <th style="width:150px">Notes</th>
                                    <th style="width:120px">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="animals-table-body">
                                <tr>
                                    <td colspan="13" style="text-align:center;padding:20px;color:#666">
                                        Loading animals...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Animals Statistics -->
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:16px">
                        <div class="stat-item">
                            <span class="stat-label">Total Animals:</span>
                            <span class="stat-value" id="total-animals-count">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Active Animals:</span>
                            <span class="stat-value" id="active-animals-count">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Breeding Animals:</span>
                            <span class="stat-value" id="breeding-animals-count">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Animals needing attention:</span>
                            <span class="stat-value" id="attention-animals-count">0</span>
                        </div>
                    </div>
                </div>

                <!-- Animal Editor Modal/Panel -->
                <div id="animal-editor" class="card" style="margin-top:16px;display:none">
                    <h4 id="animal-editor-title">Animal Details</h4>
                    <form id="animal-editor-form" class="item-form">
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                            <div><label for="edit-animal-tag">Tag / ID *</label><input type="text" id="edit-animal-tag" required /></div>
                            <div><label for="edit-animal-name">Name</label><input type="text" id="edit-animal-name" /></div>
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
                            <div><label for="edit-animal-species">Species *</label>
                                <select id="edit-animal-species" required>
                                    <option value="">--Select--</option>
                                    <option value="cattle">Cattle</option>
                                    <option value="sheep">Sheep</option>
                                    <option value="goat">Goat</option>
                                    <option value="pig">Pig</option>
                                    <option value="chicken">Chicken</option>
                                    <option value="horse">Horse</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div><label for="edit-animal-breed">Breed</label><input type="text" id="edit-animal-breed" /></div>
                            <div><label for="edit-animal-sex">Sex</label>
                                <select id="edit-animal-sex">
                                    <option value="">--</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                    <option value="unknown">Unknown</option>
                                </select>
                            </div>
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
                            <div><label for="edit-animal-dob">Date of Birth</label><input type="date" id="edit-animal-dob" /></div>
                            <div><label for="edit-animal-weight">Weight (kg)</label><input type="number" id="edit-animal-weight" step="0.1" /></div>
                            <div><label for="edit-animal-status">Status</label>
                                <select id="edit-animal-status">
                                    <option value="active">Active</option>
                                    <option value="pregnant">Pregnant</option>
                                    <option value="lactating">Lactating</option>
                                    <option value="breeding">Breeding</option>
                                    <option value="sick">Sick</option>
                                    <option value="sold">Sold</option>
                                    <option value="deceased">Deceased</option>
                                </select>
                            </div>
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
                            <div><label for="edit-animal-sire">Sire ID</label><input type="text" id="edit-animal-sire" /></div>
                            <div><label for="edit-animal-dam">Dam ID</label><input type="text" id="edit-animal-dam" /></div>
                            <div><label for="edit-animal-location">Location</label><input type="text" id="edit-animal-location" placeholder="Pasture, barn, etc." /></div>
                        </div>
                        <div><label for="edit-animal-notes">Notes</label><textarea id="edit-animal-notes" rows="3"></textarea></div>
                        <div style="display:flex;gap:8px;justify-content:flex-end">
                            <button type="button" id="animal-cancel-btn" class="btn secondary">Cancel</button>
                            <button type="submit" id="animal-save-btn" class="btn">💾 Save Animal</button>
                        </div>
                    </form>
                </div>
            </div>
                            <h4 id="animal-editor-title">Animal Details</h4>
                            <form id="animal-editor-form" class="item-form">
                                <div class="full"><label for="edit-animal-tag">Tag / ID *</label><input type="text" id="edit-animal-tag" required /></div>
                                <div class="full"><label for="edit-animal-name">Name</label><input type="text" id="edit-animal-name" /></div>
                                <div style="display:flex;gap:8px">
                                    <div style="flex:1"><label for="edit-animal-species">Species *</label>
                                        <select id="edit-animal-species" required>
                                            <option value="">--Select--</option>
                                            <option value="cattle">Cattle</option>
                                            <option value="sheep">Sheep</option>
                                            <option value="goat">Goat</option>
                                            <option value="pig">Pig</option>
                                            <option value="chicken">Chicken</option>
                                            <option value="horse">Horse</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                    <div style="flex:1"><label for="edit-animal-sex">Sex</label>
                                        <select id="edit-animal-sex">
                                            <option value="">--</option>
                                            <option value="male">Male</option>
                                            <option value="female">Female</option>
                                            <option value="unknown">Unknown</option>
                                        </select>
                                    </div>
                                </div>
                                <div style="display:flex;gap:8px">
                                    <div style="flex:1"><label for="edit-animal-dob">Date of Birth</label><input type="date" id="edit-animal-dob" /></div>
                                    <div style="flex:1"><label for="edit-animal-weight">Weight (kg)</label><input type="number" id="edit-animal-weight" step="0.1" /></div>
                                </div>
                                <div class="full"><label for="edit-animal-breed">Breed</label><input type="text" id="edit-animal-breed" /></div>
                                <div style="display:flex;gap:8px">
                                    <div style="flex:1"><label for="edit-animal-sire">Sire ID</label><input type="text" id="edit-animal-sire" /></div>
                                    <div style="flex:1"><label for="edit-animal-dam">Dam ID</label><input type="text" id="edit-animal-dam" /></div>
                                </div>
                                <div class="full"><label for="edit-animal-location">Location</label><input type="text" id="edit-animal-location" placeholder="Pasture, barn, etc." /></div>
                                <div class="full"><label for="edit-animal-status">Status</label>
                                    <select id="edit-animal-status">
                                        <option value="active">Active</option>
                                        <option value="pregnant">Pregnant</option>
                                        <option value="lactating">Lactating</option>
                                        <option value="breeding">Breeding</option>
                                        <option value="sick">Sick</option>
                                        <option value="sold">Sold</option>
                                        <option value="deceased">Deceased</option>
                                    </select>
                                </div>
                                <div class="full"><label for="edit-animal-notes">Notes</label><textarea id="edit-animal-notes" rows="3"></textarea></div>
                                <div style="display:flex;gap:8px">
                                    <button type="submit" id="animal-save-btn" class="btn">Save</button>
                                    <button type="button" id="animal-cancel-btn" class="btn secondary">Cancel</button>
                                </div>
                            </form>
                        </div>
                    </aside>
                </div>
            </div>

            <!-- Breeding Management Tab -->
            <div class="sub-section" id="animals-breeding" style="display:none">
                <div style="display:flex;gap:12px;align-items:flex-start">
                    <div style="flex:1">
                        <div class="card">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                                <h4>Breeding Records</h4>
                                <button id="btn-new-breeding" class="btn">New Breeding</button>
                            </div>
                            <div id="animals-breeding-list" class="item-list" style="max-height:400px;overflow:auto">No breeding records.</div>
                        </div>
                        
                        <div class="card" style="margin-top:12px">
                            <h4>Pregnancy Calendar</h4>
                            <div id="pregnancy-calendar" style="min-height:200px;background:#f9f9f9;border-radius:4px;padding:12px">
                                Select a pregnant animal to view due dates
                            </div>
                        </div>
                    </div>

                    <aside style="width:380px">
                        <div id="breeding-editor" class="card" style="display:none">
                            <h4>Breeding Record</h4>
                            <form id="breeding-form" class="item-form">
                                <div class="full"><label for="breeding-female">Female ID *</label><input type="text" id="breeding-female" required /></div>
                                <div class="full"><label for="breeding-male">Male ID</label><input type="text" id="breeding-male" /></div>
                                <div class="full"><label for="breeding-date">Breeding Date *</label><input type="date" id="breeding-date" required /></div>
                                <div class="full"><label for="breeding-method">Method</label>
                                    <select id="breeding-method">
                                        <option value="natural">Natural</option>
                                        <option value="ai">Artificial Insemination</option>
                                        <option value="embryo">Embryo Transfer</option>
                                    </select>
                                </div>
                                <div class="full"><label for="breeding-expected-due">Expected Due Date</label><input type="date" id="breeding-expected-due" /></div>
                                <div class="full"><label for="breeding-status">Status</label>
                                    <select id="breeding-status">
                                        <option value="bred">Bred</option>
                                        <option value="confirmed">Pregnancy Confirmed</option>
                                        <option value="failed">Failed</option>
                                        <option value="born">Offspring Born</option>
                                    </select>
                                </div>
                                <div class="full"><label for="breeding-offspring">Offspring IDs</label><input type="text" id="breeding-offspring" placeholder="Comma-separated IDs" /></div>
                                <div class="full"><label for="breeding-notes">Notes</label><textarea id="breeding-notes" rows="3"></textarea></div>
                                <div style="display:flex;gap:8px">
                                    <button type="submit" class="btn">Save</button>
                                    <button type="button" id="breeding-cancel" class="btn secondary">Cancel</button>
                                </div>
                            </form>
                        </div>

                        <div class="card" style="margin-top:12px">
                            <h4>Breeding Statistics</h4>
                            <div id="breeding-stats">
                                <div class="stat-item">
                                    <span class="stat-label">Total Breedings this year:</span>
                                    <span class="stat-value" id="stat-total-breedings">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Success Rate:</span>
                                    <span class="stat-value" id="stat-success-rate">0%</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Currently Pregnant:</span>
                                    <span class="stat-value" id="stat-pregnant">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Due this month:</span>
                                    <span class="stat-value" id="stat-due-month">0</span>
                                </div>
                            </div>
                        </div>
                    </aside>
                </div>
            </div>

            <!-- Health Management Tab -->
            <div class="sub-section" id="animals-health" style="display:none">
                <div style="display:flex;gap:12px;align-items:flex-start">
                    <div style="flex:1">
                        <div class="card">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                                <h4>Health Records</h4>
                                <button id="btn-new-health" class="btn">New Record</button>
                            </div>
                            <div style="display:flex;gap:8px;margin-bottom:12px">
                                <input type="text" id="health-search" placeholder="Search by animal ID..." style="flex:1" />
                                <select id="health-filter-type" style="width:150px">
                                    <option value="">All Types</option>
                                    <option value="vaccination">Vaccination</option>
                                    <option value="treatment">Treatment</option>
                                    <option value="checkup">Checkup</option>
                                    <option value="surgery">Surgery</option>
                                    <option value="medication">Medication</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div id="animals-health-list" class="item-list" style="max-height:450px;overflow:auto">No health records.</div>
                        </div>
                    </div>

                    <aside style="width:380px">
                        <div id="health-editor" class="card" style="display:none">
                            <h4>Health Record</h4>
                            <form id="health-form" class="item-form">
                                <div class="full"><label for="health-animal">Animal ID *</label><input type="text" id="health-animal" required /></div>
                                <div class="full"><label for="health-date">Date *</label><input type="date" id="health-date" required /></div>
                                <div class="full"><label for="health-type">Type *</label>
                                    <select id="health-type" required>
                                        <option value="">--Select--</option>
                                        <option value="vaccination">Vaccination</option>
                                        <option value="treatment">Treatment</option>
                                        <option value="checkup">Checkup</option>
                                        <option value="surgery">Surgery</option>
                                        <option value="medication">Medication</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div class="full"><label for="health-description">Description *</label><input type="text" id="health-description" required placeholder="e.g., Annual vaccination, Hoof trimming" /></div>
                                <div class="full"><label for="health-veterinarian">Veterinarian</label><input type="text" id="health-veterinarian" /></div>
                                <div style="display:flex;gap:8px">
                                    <div style="flex:1"><label for="health-cost">Cost</label><input type="number" id="health-cost" step="0.01" /></div>
                                    <div style="flex:1"><label for="health-weight">Weight (kg)</label><input type="number" id="health-weight" step="0.1" /></div>
                                </div>
                                <div class="full"><label for="health-next-due">Next Due Date</label><input type="date" id="health-next-due" /></div>
                                <div class="full"><label for="health-notes">Notes</label><textarea id="health-notes" rows="3"></textarea></div>
                                <div style="display:flex;gap:8px">
                                    <button type="submit" class="btn">Save</button>
                                    <button type="button" id="health-cancel" class="btn secondary">Cancel</button>
                                </div>
                            </form>
                        </div>

                        <div class="card" style="margin-top:12px">
                            <h4>Health Overview</h4>
                            <div id="health-overview">
                                <div class="stat-item">
                                    <span class="stat-label">Animals needing attention:</span>
                                    <span class="stat-value" id="stat-needs-attention">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Vaccinations due:</span>
                                    <span class="stat-value" id="stat-vaccinations-due">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Health events this month:</span>
                                    <span class="stat-value" id="stat-health-month">0</span>
                                </div>
                            </div>
                        </div>
                    </aside>
                </div>
            </div>

            <!-- Genealogy Tab -->
            <div class="sub-section" id="animals-genealogy" style="display:none">
                <div style="display:flex;gap:12px;align-items:flex-start">
                    <div style="flex:1">
                        <div class="card">
                            <h4>Family Tree</h4>
                            <div style="margin-bottom:12px">
                                <label for="genealogy-animal">Select Animal:</label>
                                <select id="genealogy-animal" style="margin-left:8px;width:200px">
                                    <option value="">--Select Animal--</option>
                                </select>
                            </div>
                            <div id="genealogy-tree" style="min-height:400px;background:#f9f9f9;border-radius:4px;padding:12px;overflow:auto">
                                Select an animal to view its family tree
                            </div>
                        </div>
                    </div>

                    <aside style="width:320px">
                        <div class="card">
                            <h4>Offspring</h4>
                            <div id="genealogy-offspring" style="max-height:200px;overflow:auto">
                                Select an animal to view offspring
                            </div>
                        </div>

                        <div class="card" style="margin-top:12px">
                            <h4>Lineage Summary</h4>
                            <div id="genealogy-summary">
                                <div class="stat-item">
                                    <span class="stat-label">Generation:</span>
                                    <span class="stat-value" id="stat-generation">-</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Total Offspring:</span>
                                    <span class="stat-value" id="stat-total-offspring">-</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Breeding Value:</span>
                                    <span class="stat-value" id="stat-breeding-value">-</span>
                                </div>
                            </div>
                        </div>
                    </aside>
                </div>
            </div>

            <!-- Performance Tab -->
            <div class="sub-section" id="animals-performance" style="display:none">
                <div style="display:flex;gap:12px;align-items:flex-start">
                    <div style="flex:1">
                        <div class="card">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                                <h4>Performance Records</h4>
                                <button id="btn-new-performance" class="btn">New Record</button>
                            </div>
                            <div style="display:flex;gap:8px;margin-bottom:12px">
                                <input type="text" id="performance-search" placeholder="Search by animal ID..." style="flex:1" />
                                <select id="performance-filter-type" style="width:150px">
                                    <option value="">All Types</option>
                                    <option value="weight">Weight</option>
                                    <option value="milk">Milk Production</option>
                                    <option value="wool">Wool Production</option>
                                    <option value="eggs">Egg Production</option>
                                    <option value="growth">Growth Rate</option>
                                    <option value="feed">Feed Conversion</option>
                                </select>
                            </div>
                            <div id="animals-performance-list" class="item-list" style="max-height:450px;overflow:auto">No performance records.</div>
                        </div>
                    </div>

                    <aside style="width:380px">
                        <div id="performance-editor" class="card" style="display:none">
                            <h4>Performance Record</h4>
                            <form id="performance-form" class="item-form">
                                <div class="full"><label for="performance-animal">Animal ID *</label><input type="text" id="performance-animal" required /></div>
                                <div class="full"><label for="performance-date">Date *</label><input type="date" id="performance-date" required /></div>
                                <div class="full"><label for="performance-type">Type *</label>
                                    <select id="performance-type" required>
                                        <option value="">--Select--</option>
                                        <option value="weight">Weight</option>
                                        <option value="milk">Milk Production</option>
                                        <option value="wool">Wool Production</option>
                                        <option value="eggs">Egg Production</option>
                                        <option value="growth">Growth Rate</option>
                                        <option value="feed">Feed Conversion</option>
                                    </select>
                                </div>
                                <div style="display:flex;gap:8px">
                                    <div style="flex:1"><label for="performance-value">Value *</label><input type="number" id="performance-value" step="0.01" required /></div>
                                    <div style="flex:1"><label for="performance-unit">Unit</label><input type="text" id="performance-unit" placeholder="kg, L, etc." /></div>
                                </div>
                                <div class="full"><label for="performance-notes">Notes</label><textarea id="performance-notes" rows="2"></textarea></div>
                                <div style="display:flex;gap:8px">
                                    <button type="submit" class="btn">Save</button>
                                    <button type="button" id="performance-cancel" class="btn secondary">Cancel</button>
                                </div>
                            </form>
                        </div>

                        <div class="card" style="margin-top:12px">
                            <h4>Performance Charts</h4>
                            <div id="performance-chart" style="min-height:250px;background:#f9f9f9;border-radius:4px;padding:12px">
                                Select an animal and performance type to view charts
                            </div>
                        </div>
                    </aside>
                </div>
            </div>
        </section>

        <section id="attachments" class="section">
            <h2>Attachments (photos, files)</h2>
            <nav class="subnav">
                <button data-sub="gallery" class="active">Gallery</button>
                <button data-sub="upload">Upload</button>
                <button data-sub="linked">Linked</button>
            </nav>

            <div class="sub-section" id="attachments-gallery">
                <div id="attachments-gallery-grid" class="gallery">No attachments yet.</div>
            </div>

            <div class="sub-section" id="attachments-upload" style="display:none">
                <form id="attachment-form" class="item-form">
                    <input type="file" id="attachment-file" />
                    <input type="text" id="attachment-desc" placeholder="Description / link to record id" />
                    <button type="submit">Upload</button>
                </form>
            </div>

            <div class="sub-section" id="attachments-linked" style="display:none">
                <h4>Files linked to records (fields, activities, animals)</h4>
                <div id="attachments-linked-list">No linked files.</div>
            </div>
        </section>

        <section id="reports" class="section">
            <h2>Reports & Analytics</h2>
            <nav class="subnav">
                <button data-sub="production" class="active">Production</button>
                <button data-sub="finance">Finance</button>
                <button data-sub="inventory">Inventory</button>
                <button data-sub="activities">Activities</button>
            </nav>

            <div class="sub-section" id="reports-production">
                <div id="report-controls" class="card">
                    <label for="report-select">Select report:</label>
                    <select id="report-select"><option value="">-- choose report --</option></select>
                    <button id="report-view-btn" class="btn">View</button>
                    <button id="report-download-btn" class="btn">Download (.doc)</button>
                </div>
                <div id="report-viewer" class="card" style="margin-top:12px;">Select a report to view.</div>
                <div id="report-production-table"></div>
            </div>

            <div class="sub-section" id="reports-finance" style="display:none">
                <div id="report-finance">Finance reports and P&L.</div>
            </div>

            <div class="sub-section" id="reports-inventory" style="display:none">
                <p>Inventory valuation and movements report.</p>
            </div>

            <div class="sub-section" id="reports-activities" style="display:none">
                <p>Activity logs and analytics.</p>
            </div>
        </section>

        <section id="tasks" class="section">
            <h2>Tasks & Scheduling</h2>
            <nav class="subnav">
                <button data-sub="board" class="active">Board</button>
                <button data-sub="calendar">Calendar</button>
                <button data-sub="completed">Completed</button>
            </nav>

            <div class="sub-section" id="tasks-board">
                <form id="task-form" class="item-form">
                    <input type="text" id="task-title" placeholder="Task title" required />
                    <input type="date" id="task-date" />
                    <input type="text" id="task-assignee" placeholder="Assign to" />
                    <button type="submit">Add Task</button>
                </form>
                <div id="task-list" class="item-list">No tasks yet.</div>
            </div>

            <div class="sub-section" id="tasks-calendar" style="display:none">
                <p>Task calendar view and reminders.</p>
            </div>

            <div class="sub-section" id="tasks-completed" style="display:none">
                <p>Completed tasks archive.</p>
            </div>
        </section>

        <section id="finance" class="section">
            <h2>Finance (Income & Expenses)</h2>
            <nav class="subnav">
                <button data-sub="summary" class="active">Summary</button>
                <button data-sub="records">Records</button>
                <button data-sub="reports">Reports</button>
            </nav>

            <div class="sub-section" id="finance-summary-view">
                <div id="finance-summary" class="summary">Summary: —</div>
            </div>

            <div class="sub-section" id="finance-records" style="display:none">
                <form id="finance-form" class="item-form">
                    <input type="text" id="fin-desc" placeholder="Description (Sale, Seed purchase)" required />
                    <input type="number" id="fin-amount" placeholder="Amount (positive income, negative expense)" step="0.01" required />
                    <select id="fin-type">
                        <option value="income">Income</option>
                        <option value="expense">Expense</option>
                    </select>
                    <button type="submit">Add Record</button>
                </form>
                <div id="finance-list" class="item-list">No finance records yet.</div>
            </div>

            <div class="sub-section" id="finance-reports" style="display:none">
                <p>Finance P&L, cashflow and export options.</p>
            </div>
        </section>
    </main>

    <footer>
        <small>Vetshub — local-only PWA for farm management (data stored in your browser)</small>
    </footer>

    </div> <!-- .layout -->

    <!-- Leaflet JS (no SRI to avoid integrity decode errors in dev host) -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <script type="module" src="src/main.js"></script>

    <!-- Modal editor -->
    <div id="modal" class="modal" aria-hidden="true">
        <div class="modal-backdrop"></div>
        <div class="modal-panel" role="dialog" aria-modal="true">
            <header class="modal-header">
                <h3 id="modal-title">Edit</h3>
                <button id="modal-close" class="btn">Close</button>
            </header>
            <div class="modal-body">
                <form id="modal-form"></form>
            </div>
            <footer class="modal-footer">
                <button id="modal-save" class="btn">Save</button>
            </footer>
        </div>
    </div>
</body>
</html>